<html>
   <head>
      <script src="view/drawable.js"></script>
      <script src="view/pipeline.js"></script>
      <script src="simulation.js"></script>
      <style>
         canvas {
            border: solid black 5px;
            margin: 0;
         }
      </style>
   </head>
   <body>
      <canvas width=700 height=700> </canvas>
      <script>
         let canvas = document.querySelector("canvas");
         let ctx = canvas.getContext("2d");
         let simulation = new Simulation(canvas.clientWidth, canvas.clientHeight, 1);

         let particle3 = new Particle(3, .005, new Vector(0, 400), 10);
         particle3.velocity = new Vector(300, 0);
         let particle2 = new Particle(300, 1, new Vector(-200, 0), 50);
         particle2.velocity = new Vector(0, -200);
         let particle4 = new Particle(300, 1, new Vector(200, 0), 20);
         particle4.velocity = new Vector(0, 200);
         simulation.add(particle2);
         simulation.add(particle3);
         simulation.add(particle4);

         let layers = new LayerDrawer();
         let drawables = [];
         for(let p of simulation.getParticles()) {
            let drawable = new ParticleDrawable(p);
            drawables.push(drawable);
            
            layers.add(drawable, 2);
            layers.add(drawable.getVelocityDrawable(), 1);
            layers.add(drawable.getForceDrawable(), 1);
         }

         //All camera things
         let camera = new Camera();
         let dragging = false;
         let lastDrag = null;
         document.addEventListener("mousedown", evt => { 
            dragging = true;
            lastDrag = new Vector(evt.clientX, evt.clientY);
         });
         document.addEventListener("mousemove", evt => {
            if(dragging) {
               let currPos = new Vector(evt.clientX, evt.clientY);
               let drag = currPos.sub(lastDrag);
               lastDrag = currPos;

               camera.translate(drag);
            }
         }); 
         document.addEventListener("mouseup", () => dragging = false);
         document.addEventListener("mousewheel", evt => {
            evt.stopPropagation();
            
            let scaling = evt.wheelDeltaY >= 0 ? 1.05 : 0.95;
            camera.scale(scaling);
         });

         let pipeline = new Pipeline(ctx);
         pipeline.add(new Clearer());
         pipeline.add(camera); 
         pipeline.add(new Flipper());
         pipeline.add(new Gridder("rgba(150, 150, 150, .5)", 20, 20, 1));
         pipeline.add(layers);

         simulation.start();
         pipeline.run();
      </script>
   </body>
</html>
